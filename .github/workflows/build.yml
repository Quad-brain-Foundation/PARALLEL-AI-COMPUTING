name: parallel-ai-v4

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  ############################################################
  # 0) Preparation
  ############################################################
  prepare:
    runs-on: ubuntu-latest
    outputs:
      input_path: ${{ steps.out.outputs.input_path }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare input
        id: out
        run: |
          mkdir ai_input
          echo "Snapshot: $(date)" > ai_input/info.txt
          echo "input_path=ai_input" >> $GITHUB_OUTPUT


  ############################################################
  # 1) Parallel AI Nodes (8 Units)
  ############################################################

  ai_code_analyzer:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_code
          echo "Analysis_OK" > out_code/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_code
          path: out_code

  ai_transpiler:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_trans
          echo "Transpile_OK" > out_trans/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_transpiler
          path: out_trans

  ai_spec:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_spec
          echo "Spec_OK" > out_spec/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_spec
          path: out_spec

  ai_meaning:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_meaning
          echo "Meaning_OK" > out_meaning/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_meaning
          path: out_meaning

  ai_nasm_opt:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_nasm
          echo "NASM_Optimize_OK" > out_nasm/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_nasm
          path: out_nasm

  ai_build_planner:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_plan
          echo "BuildPlan_OK" > out_plan/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_plan
          path: out_plan

  ai_security:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_sec
          echo "Security_OK" > out_sec/msg.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_sec
          path: out_sec

  ai_proof:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir out_proof
          echo "SHA256: $(echo test | sha256sum)" > out_proof/proof.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ai_proof
          path: out_proof


  ############################################################
  # 2) 3OS Build (Ubuntu / macOS / Windows)
  ############################################################
  build_3os:
    needs:
      [
        ai_code_analyzer,
        ai_transpiler,
        ai_spec,
        ai_meaning,
        ai_nasm_opt,
        ai_build_planner,
        ai_security,
        ai_proof
      ]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Build per OS
        run: |
          mkdir build
          echo "Build for ${{ matrix.os }} OK" > build/build.txt

      - uses: actions/upload-artifact@v4
        with:
          name: build_${{ matrix.os }}
          path: build


  ############################################################
  # 3) Aggregate AI Outputs + 3OS Builds
  ############################################################
  aggregate:
    runs-on: ubuntu-latest
    needs: build_3os
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: collected

      - name: Generate Final ProofLedger
        run: |
          mkdir final
          echo "=== PARALLEL AI V4 PIPELINE ===" > final/ProofLedger.txt
          echo "Generated: $(date)" >> final/ProofLedger.txt
          echo "" >> final/ProofLedger.txt
          find collected -type f -exec echo "{}" >> final/ProofLedger.txt \;

      - uses: actions/upload-artifact@v4
        with:
          name: final_proofledger
          path: final

      - name: Commit updated ProofLedger
        run: |
          cp final/ProofLedger.txt ProofLedger-latest.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ProofLedger-latest.txt
          git commit -m "Update ProofLedger"
          git push


  ############################################################
  # 4) Auto Release + Version Tag (OS별 ZIP 포함)
  ############################################################
  release:
    runs-on: ubuntu-latest
    needs: aggregate
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected_release

      - name: Generate auto version tag
        id: version
        run: |
          VER="v$(date +'%Y%m%d%H%M%S')"
          echo "version=$VER" >> $GITHUB_OUTPUT

      ########################################################
      # OS별 ZIP 개별 생성
      ########################################################
      - name: Create OS ZIPs
        run: |
          mkdir os_zip
          cd collected_release

          if [ -d "build_ubuntu-latest" ]; then
            cd build_ubuntu-latest
            zip -r ../../os_zip/ubuntu_build.zip .
            cd ..
          fi

          if [ -d "build_macos-latest" ]; then
            cd build_macos-latest
            zip -r ../../os_zip/macos_build.zip .
            cd ..
          fi

          if [ -d "build_windows-latest" ]; then
            cd build_windows-latest
            zip -r ../../os_zip/windows_build.zip .
            cd ..
          fi

          # Full bundle
          zip -r ../os_zip/full_bundle.zip .
          cd ..

      ########################################################
      # Release Notes 생성
      ########################################################
      - name: Create Release Notes
        run: |
          echo "Parallel-AI V4 Auto Release" > release_notes.txt
          echo "Version: ${{ steps.version.outputs.version }}" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "OS별 빌드:" >> release_notes.txt
          echo "- ubuntu_build.zip" >> release_notes.txt
          echo "- macos_build.zip" >> release_notes.txt
          echo "- windows_build.zip" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "전체 Bundle: full_bundle.zip" >> release_notes.txt

      ########################################################
      # GitHub Release 생성
      ########################################################
      - name: Create GitHub Release with Tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Parallel-AI Release ${{ steps.version.outputs.version }}"
          body_path: release_notes.txt
          files: |
            os_zip/ubuntu_build.zip
            os_zip/macos_build.zip
            os_zip/windows_build.zip
            os_zip/full_bundle.zip
            collected_release/final_proofledger/ProofLedger.txt
